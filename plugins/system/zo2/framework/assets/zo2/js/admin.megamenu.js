var ZO2AdminMegamenu=window.ZO2AdminMegamenu||{};!function($){var currentSelected=null,megamenu,nav_items,nav_subs,nav_cols,nav_all;$.fn.megamenuAdmin=function(options){var defaultOptions={};var options=$.extend(defaultOptions,options);megamenu=$(this).find('.zo2-megamenu');nav_items=megamenu.find('ul[class*="level"]>li>:first-child');nav_subs=megamenu.find('.menu-child');nav_cols=megamenu.find('[class*="span"]');nav_all=nav_items.add(nav_subs).add(nav_cols);nav_items.each(function(){var a=$(this),liitem=a.closest('li');if(liitem.data('hidesub')==1){var sub=liitem.find('.menu-child:first');sub.css('display','none');a.removeClass('dropdown-toggle').data('toggle','');liitem.removeClass('dropdown dropdown-submenu mega');}});hide_toolbox(true);bindEvents(nav_all);$('.toolbox-action, .toolbox-toggle, .toolbox-input').unbind("focus blur click change keydown");$('.zo2-admin-mm-row').click(function(event){event.stopPropagation();});$(document.body).click(function(event){hide_toolbox(true);});$('.toolbox-action').click(function(event){var action=$(this).data('action');if(action){actions.datas=$(this).data();actions[action]();}
event.stopPropagation();return false;});$('.toolbox-toggle').change(function(event){var action=$(this).data('action');if(action){actions.datas=$(this).data();actions[action]();}
event.stopPropagation();return false;});$('.toolbox-input').bind('focus blur click',function(event){event.stopPropagation();return false;});$('.toolbox-input').bind('keydown',function(event){if(event.keyCode=='13'){apply_toolbox(this);event.preventDefault();}});$('.toolbox-input').change(function(event){apply_toolbox(this);event.stopPropagation();return false;});return this;};var actions={};actions.data={};actions.toggleSub=function(){if(!currentSelected)
return;var liitem=currentSelected.closest('li'),sub=liitem.find('.menu-child:first');if(liitem.data('group'))
return;if(sub.length==0||sub.css('display')=='none'){if(sub.length==0){sub=$('<div class="menu-child  dropdown-menu mega-dropdown-menu"><div class="row-fluid"><div class="span12" data-width="12"><div class="mega-inner"></div></div></div></div>').appendTo(liitem);bindEvents(sub.find('[class*="span"]'));liitem.addClass('mega');}else{sub.css('display','');liitem.data('hidesub',0);}
liitem.data('group',0);currentSelected.addClass('dropdown-toggle').data('toggle','dropdown');liitem.addClass(liitem.data('level')==1?'dropdown':'dropdown-submenu');bindEvents(sub);}else{unbindEvents(sub);if(liitem.find('ul.level'+liitem.data('level')).length>0){sub.css('display','none');liitem.data('hidesub',1);}else{sub.remove();}
liitem.data('group',0);currentSelected.removeClass('dropdown-toggle').data('toggle','');liitem.removeClass('dropdown dropdown-submenu mega');}
update_toolbox();}
actions.toggleGroup=function(){if(!currentSelected)
return;var liitem=currentSelected.parent(),sub=liitem.find('.menu-child:first');if(liitem.data('level')==1)
return;if(liitem.data('group')){liitem.data('group',0);liitem.removeClass('mega-group').addClass('dropdown-submenu');currentSelected.addClass('dropdown-toggle').data('toggle','dropdown');sub.removeClass('mega-group-content').addClass('dropdown-menu mega-dropdown-menu');sub.css('width',sub.data('width'));rebindEvents(sub);}else{currentSelected.removeClass('dropdown-toggle').data('toggle','');liitem.data('group',1);liitem.removeClass('dropdown-submenu').addClass('mega-group');sub.removeClass('dropdown-menu mega-dropdown-menu').addClass('mega-group-content');sub.css('width','');rebindEvents(sub);}
update_toolbox();}
actions.moveItemsLeft=function(){if(!currentSelected)
return;var $item=currentSelected.closest('li'),$liparent=$item.parent().closest('li'),level=$liparent.data('level'),$col=$item.closest('[class*="span"]'),$items=$col.find('ul:first > li'),itemidx=$items.index($item),$moveitems=$items.slice(0,itemidx+1),itemleft=$items.length-$moveitems.length,$rows=$col.parent().parent().children('[class*="row"]'),$cols=$rows.children('[class*="span"]').filter(function(){return!$(this).data('module_id')}),colidx=$cols.index($col);if(!$liparent.length)
return;if(colidx==0){var oldSelected=currentSelected;currentSelected=$col;actions.datas.addfirst=true;actions.addColumn();$cols=$rows.children('[class*="span"]').filter(function(){return!$(this).data('module_id')});currentSelected=oldSelected;colidx++;}
var $tocol=$($cols[colidx-1]);var $ul=$tocol.find('ul:first');if(!$ul.length){$ul=$('<ul class="mega-nav level'+level+'">').appendTo($tocol.children('.mega-inner'));}
$moveitems.appendTo($ul);if(itemleft==0){$col.find('ul:first').remove();}
update_toolbox();}
actions.moveItemsRight=function(){if(!currentSelected)
return;var $item=currentSelected.closest('li'),$liparent=$item.parent().closest('li'),level=$liparent.data('level'),$col=$item.closest('[class*="span"]'),$items=$col.find('ul:first > li'),itemidx=$items.index($item),$moveitems=$items.slice(itemidx),itemleft=$items.length-$moveitems.length,$rows=$col.parent().parent().children('[class*="row"]'),$cols=$rows.children('[class*="span"]').filter(function(){return!$(this).data('module_id')}),colidx=$cols.index($col);if(!$liparent.length)
return;if(colidx==$cols.length-1){var oldSelected=currentSelected;currentSelected=$col;actions.datas.addfirst=false;actions.addColumn();$cols=$rows.children('[class*="span"]').filter(function(){return!$(this).data('module_id')});currentSelected=oldSelected;}
var $tocol=$($cols[colidx+1]);var $ul=$tocol.find('ul:first');if(!$ul.length){$ul=$('<ul class="mega-nav level'+level+'">').appendTo($tocol.children('.mega-inner'));}
$moveitems.prependTo($ul);if(itemleft==0){$col.find('ul:first').remove();}
show_toolbox(currentSelected);}
actions.addRow=function(){if(!currentSelected)
return;var $row=$('<div class="row-fluid"><div class="span12"><div class="mega-inner"></div></div></div>').appendTo(currentSelected.find('.mega-dropdown-inner')),$col=$row.children();bindEvents($col);currentSelected=null;show_toolbox($col);}
actions.alignment=function(){var liitem=currentSelected.closest('li');liitem.removeClass('mega-align-left mega-align-center mega-align-right mega-align-justify').addClass('mega-align-'+actions.datas.align);if(actions.datas.align=='justify'){currentSelected.addClass('span12');currentSelected.css('width','');}else{currentSelected.removeClass('span12');if(currentSelected.data('width'))
currentSelected.css('width',currentSelected.data('width'));}
liitem.data('alignsub',actions.datas.align);update_toolbox();}
actions.addColumn=function(){if(!currentSelected)
return;var $cols=currentSelected.parent().children('[class*="span"]'),colcount=$cols.length+1,colwidths=defaultColumnsWidth(colcount);var $col=$('<div><div class="mega-inner"></div></div>');if(actions.datas.addfirst)
$col.prependTo(currentSelected.parent());else{$col.insertAfter(currentSelected);}
$cols=$cols.add($col);bindEvents($col);$cols.each(function(i){$(this).removeClass('span'+$(this).data('width')).addClass('span'+colwidths[i]).data('width',colwidths[i]);});show_toolbox($col);}
actions.removeColumn=function(){if(!currentSelected){return;}
var $col=currentSelected,$row=$col.parent(),$rows=$row.parent().children('[class*="row"]'),$allcols=$rows.children('[class*="span"]'),$allmenucols=$allcols.filter(function(){return!$(this).data('module_id')}),$haspos=$allcols.filter(function(){return $(this).data('module_id')}).length,$cols=$row.children('[class*="span"]'),colcount=$cols.length-1,colwidths=defaultColumnsWidth(colcount),type_menu=$col.data('module_id')?false:true;if((type_menu&&((!$haspos&&$allmenucols.length==1)||($haspos&&$allmenucols.length==0)))||$allcols.length==1){return;}
if(type_menu){var colidx=$allmenucols.index($col),tocol=colidx==0?$allmenucols[1]:$allmenucols[colidx-1];$col.find('ul:first > li').appendTo($(tocol).find('ul:first'));}
var colidx=$allcols.index($col),nextActiveCol=colidx==0?$allcols[1]:$allcols[colidx-1];if(colcount<1){$row.remove();}else{$cols=$cols.not($col);$cols.each(function(i){$(this).removeClass('span'+$(this).data('width')).addClass('span'+colwidths[i]).data('width',colwidths[i]);});$col.remove();}
show_toolbox($(nextActiveCol));}
actions.hideWhenCollapse=function(){if(!currentSelected)
return;var type=toolbox_type();if(type=='sub'){var liitem=currentSelected.closest('li');if(liitem.data('hidewcol')){liitem.data('hidewcol',0);liitem.removeClass('sub-hidden-collapse');}else{liitem.data('hidewcol',1);liitem.addClass('sub-hidden-collapse');}}else if(type=='col'){if(currentSelected.data('hidewcol')){currentSelected.data('hidewcol',0);currentSelected.removeClass('hidden-collapse');}else{currentSelected.data('hidewcol',1);currentSelected.addClass('hidden-collapse');}}
update_toolbox();}
actions.saveConfig=function(e){var config={},items=megamenu.find('ul[class*="level"] > li');items.each(function(){var $this=$(this),id='item-'+$this.data('id'),item={};if($this.hasClass('mega')){var $sub=$this.find('.menu-child:first');item['submenu']={};for(var d in $sub.data()){if(d!='id'&&d!='level'&&$sub.data(d))
item['submenu'][d]=$sub.data(d);}
var $rows=$sub.find('[class*="row"]:first').parent().children('[class*="row"]'),rows=[],i=0;$rows.each(function(){var row=[],$cols=$(this).children('[class*="span"]'),j=0;$cols.each(function(){var li=$(this).find('ul[class*="level"] > li:first'),col={};if(li.length){col['item']=li.data('id');}else if($(this).data('module_id')){col['module_id']=$(this).data('module_id');}else{col['item']=-1;}
for(var d in $(this).data()){if(d!='id'&&d!='level'&&d!='module_id'&&$(this).data(d))
col[d]=$(this).data(d);}
row[j++]=col;});rows[i++]=row;});item['submenu']['rows']=rows;}
for(var d in $this.data()){if(d!='id'&&d!='level'&&$this.data(d)){if(d=='caption'){item[d]=$this.data(d).replace(/</g,"[lt]").replace(/>/g,"[gt]");}
else
item[d]=$this.data(d);}}
if(Object.keys(item).length)
config[id]=item;});var menutype=$('#jform_params_menu_type').val(),jmmconfig=$('#jform_params_menu_config'),curconfig=null;try{curconfig=jmmconfig.val()?$.parseJSON(jmmconfig.val()):{};}catch(e){curconfig={};}
if($.isArray(curconfig)&&curconfig.length==0){curconfig={};}
curconfig[menutype]=config;jmmconfig.val(JSON.stringify(curconfig));}
toolbox_type=function(){return currentSelected.hasClass('menu-child ')?'sub':(currentSelected.length>0&&currentSelected[0].tagName=='DIV'?'col':'item');}
hide_toolbox=function(show_intro){$('#zo2-admin-mm-tb .admin-toolbox').hide();currentSelected=null;if(megamenu&&megamenu.data('nav_all'))
megamenu.data('nav_all').removeClass('selected');megamenu.find('li').removeClass('open');if(show_intro){$('#zo2-admin-mm-intro').show();}else{$('#zo2-admin-mm-intro').hide();}}
show_toolbox=function(selected){hide_toolbox(false);if(selected)
currentSelected=selected;megamenu.find('ul[class*="level"] > li').each(function(){if(!$(this).has(currentSelected).length>0)
$(this).removeClass('open');else
$(this).addClass('open');});megamenu.data('nav_all').removeClass('selected');currentSelected.addClass('selected');var type=toolbox_type();$('#zo2-admin-mm-tool'+type).show();update_toolbox(type);$('#zo2-admin-mm-tb').show();}
update_toolbox=function(type){if(!type)
type=toolbox_type();$('#zo2-admin-mm-tb .disabled').removeClass('disabled');$('#zo2-admin-mm-tb .active').removeClass('active');switch(type){case'item':var liitem=currentSelected.closest('li'),liparent=liitem.parent().closest('li'),sub=liitem.find('.menu-child:first');$('.toolitem-exclass').attr('value',liitem.data('class')||'');$('.toolitem-xicon').attr('value',liitem.data('xicon')||'');$('.toolitem-caption').attr('value',liitem.data('caption')||'');var toggle=$('.toolitem-sub');toggle.find('label').removeClass('active btn-success btn-danger btn-primary');if(liitem.data('group')){$('.toolitem-sub').addClass('disabled');}else if(sub.length==0||sub.css('display')=='none'){update_toggle(toggle,0);}else{update_toggle(toggle,1);}
var toggle=$('.toolitem-group');toggle.find('label').removeClass('active btn-success btn-danger btn-primary');if(liitem.data('level')==1||sub.length==0||liitem.data('hidesub')==1){$('.toolitem-group').addClass('disabled');}else if(liitem.data('group')){update_toggle(toggle,1);}else{update_toggle(toggle,0);}
if(!liparent.length||!liparent.hasClass('mega')){$('.toolitem-moveleft, .toolitem-moveright').addClass('disabled');}
break;case'sub':var liitem=currentSelected.closest('li');$('.toolsub-exclass').attr('value',currentSelected.data('class')||'');if(liitem.data('group')){$('.toolsub-width').attr('value','').addClass('disabled');$('.toolitem-alignment').addClass('disabled');}else{$('.toolsub-width').attr('value',currentSelected.data('width')||'');if(liitem.data('level')>1){$('.toolsub-align-center').addClass('disabled');$('.toolsub-align-justify').addClass('disabled');}
if(liitem.data('alignsub')){$('.toolsub-align-'+liitem.data('alignsub')).addClass('active');if(liitem.data('alignsub')=='justify'){$('.toolsub-width').addClass('disabled');}}}
var toggle=$('.toolsub-hidewhencollapse');toggle.find('label').removeClass('active btn-success btn-danger btn-primary');if(liitem.data('hidewcol')){update_toggle(toggle,1);}else{update_toggle(toggle,0);}
break;case'col':$('.toolcol-exclass').attr('value',currentSelected.data('class')||'');$('.toolcol-module').val(currentSelected.data('module_id')||'').trigger("liszt:updated");$('.toolcol-width').val(currentSelected.data('width')||'').trigger("liszt:updated");if(currentSelected.find('.mega-nav').length>0){$('.toolcol-module').parent().addClass('disabled');}
if(currentSelected.parent().children().length==1){$('.toolcol-width').parent().addClass('disabled');}
var toggle=$('.toolcol-hidewhencollapse');toggle.find('label').removeClass('active btn-success btn-danger btn-primary');if(currentSelected.data('hidewcol')){update_toggle(toggle,1);}else{update_toggle(toggle,0);}
break;}}
update_toggle=function(toggle,val){$input=toggle.find('input[value="'+val+'"]');$input.attr('checked','checked');$input.trigger('update');}
apply_toolbox=function(input){var name=$(input).data('name'),value=input.value,type=toolbox_type();switch(name){case'width':if(type=='sub'){currentSelected.width(value);}
if(type=='col'){currentSelected.removeClass('span'+currentSelected.data(name)).addClass('span'+value);}
currentSelected.data(name,value);break;case'class':if(type=='item'){var item=currentSelected.closest('li');}else{var item=currentSelected;}
item.removeClass(item.data(name)||'').addClass(value);item.data(name,value);break;case'xicon':if(type=='item'){currentSelected.closest('li').data(name,value);currentSelected.find('i').remove();if(value)
currentSelected.prepend($('<i class="'+value+'"></i>'));}
break;case'caption':if(type=='item'){currentSelected.closest('li').data(name,value);currentSelected.find('span.mega-caption').remove();if(value)
currentSelected.append($('<span class="mega-caption">'+value+'</span>'));}
break;case'module_id':if(currentSelected.find('ul[class*="level"]').length==0){if(value){$.ajax({url:Assets.url,data:{'zo2controller':'module','module_id':value}}).done(function(data){currentSelected.find('.mega-inner').html(data).find(':input').removeAttr('name');});}else{currentSelected.find('.mega-inner').html('');}
currentSelected.data(name,value);}
break;}}
defaultColumnsWidth=function(count){if(count<1)
return null;var total=12,min=Math.floor(total / count),widths=[];for(var i=0;i<count;i++){widths[i]=min;}
widths[count-1]=total-min*(count-1);return widths;}
bindEvents=function(els){if(megamenu.data('nav_all'))
megamenu.data('nav_all',megamenu.data('nav_all').add(els));else
megamenu.data('nav_all',els);els.mouseover(function(event){megamenu.data('nav_all').removeClass('hover');$this=$(this);clearTimeout(megamenu.data('hovertimeout'));megamenu.data('hovertimeout',setTimeout("$this.addClass('hover')",100));event.stopPropagation();});els.mouseout(function(event){clearTimeout(megamenu.data('hovertimeout'));$(this).removeClass('hover');});els.click(function(event){show_toolbox($(this));event.stopPropagation();return false;});}
unbindEvents=function(els){megamenu.data('nav_all',megamenu.data('nav_all').not(els));els.unbind('mouseover').unbind('mouseout').unbind('click');}
rebindEvents=function(els){unbindEvents(els);bindEvents(els);}}(jQuery);!function($){$.extend(ZO2AdminMegamenu,{prepare:function(){var panel=$('#jform_params_mm_type').closest('.controls');panel.append($('#zo2-admin-megamenu').removeClass('hidden'));if($('#jform_params_nav_type').val()=='megamenu'){setTimeout(function(){$('#jform_params_menu_type').trigger('change.less');},500);}else{$('#jform_params_nav_type').on('change',function(e){if($(this).val()=='megamenu'){$('#jform_params_menu_type').trigger('change.less');}});}},megamenu:function(form,ctrlelm,ctrl,rsp){$('#zo2-admin-mm-container').html(rsp).megamenuAdmin().find(':input').removeAttr('name');},initPanel:function(){$('#jform_params_mm_panel').hide();},initPreSubmit:function(){var form=document.adminForm;if(!form){return false;}
var onsubmit=form.onsubmit;form.onsubmit=function(e){$('.toolbox-saveConfig').trigger('click');if($.isFunction(onsubmit)){onsubmit();}};},initRadioGroup:function(){if(typeof ZO2Admin!='undefined'){return true;}
var zo2_admin=$('.zo2-admin-megamenu');zo2_admin.find('.radio.btn-group label').addClass('btn');zo2_admin.find('.btn-group label').unbind('click').click(function(){var label=$(this),input=$('#'+label.attr('for'));if(!input.prop('checked')){label.closest('.btn-group').find('label').removeClass('active btn-success btn-danger btn-primary');label.addClass('active '+(input.val()==''?'btn-primary':(input.val()==0?'btn-danger':'btn-success')));input.prop('checked',true).trigger('change');}});zo2_admin.on('update','input[type=radio]',function(){if(this.checked){$(this).closest('.btn-group').find('label').removeClass('active btn-success btn-danger btn-primary').filter('[for="'+this.id+'"]').addClass('active '+($(this).val()==''?'btn-primary':($(this).val()==0?'btn-danger':'btn-success')));}});zo2_admin.find('.btn-group input[checked=checked]').each(function(){if($(this).val()==''){$('label[for='+$(this).attr('id')+']').addClass('active btn-primary');}else if($(this).val()==0){$('label[for='+$(this).attr('id')+']').addClass('active btn-danger');}else{$('label[for='+$(this).attr('id')+']').addClass('active btn-success');}});}});$(window).load(function(){ZO2AdminMegamenu.prepare();});$(document).ready(function(){ZO2AdminMegamenu.initPanel();ZO2AdminMegamenu.initPreSubmit();ZO2AdminMegamenu.initRadioGroup();});}(jQuery);